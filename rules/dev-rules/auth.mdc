---
description: 
globs: 
alwaysApply: true
---
# Supabase èªè¨¼å®Ÿè£…ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ãŸã‚‰ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç™ºè¨€ã™ã‚‹ã“ã¨

## ç’°å¢ƒå¤‰æ•°è¨­å®š

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š

```typescript
// src/middleware.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { updateSession } from "@/lib/supabase/middleware";

export const middleware = (req: NextRequest) => {
  return updateSession(req);
};

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|images|favicon.ico).*)"],
};
```

## Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š

### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰
```typescript
// lib/supabase/server.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'

export function createClient() {
  const cookieStore = cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options })
          } catch (error) {
            // Server Componentã‹ã‚‰ã®å‘¼ã³å‡ºã—æ™‚ã¯ç„¡è¦–
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options })
          } catch (error) {
            // Server Componentã‹ã‚‰ã®å‘¼ã³å‡ºã—æ™‚ã¯ç„¡è¦–
          }
        },
      },
    }
  )
}
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰
```typescript
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
```typescript
// lib/supabase/middleware.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value,
            ...options,
          })
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value: '',
            ...options,
          })
        },
      },
    }
  )

  await supabase.auth.getUser()
  return response
}
```

## èªè¨¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
```typescript
// components/auth/AuthForm.tsx
"use client";

import { useState } from "react";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { toast } from "sonner";

export function AuthForm() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const supabase = createClient();

  const handleSignIn = async () => {
    setLoading(true);
    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    
    if (error) {
      toast.error("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } else {
      toast.success("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸ");
    }
    setLoading(false);
  };

  const handleSignUp = async () => {
    setLoading(true);
    const { error } = await supabase.auth.signUp({
      email,
      password,
    });
    
    if (error) {
      toast.error("ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } else {
      toast.success("ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    }
    setLoading(false);
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader>
        <CardTitle>ãƒ­ã‚°ã‚¤ãƒ³</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <Input
          type="email"
          placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />
        <Input
          type="password"
          placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
        />
        <div className="space-y-2">
          <Button 
            onClick={handleSignIn} 
            loading={loading}
            className="w-full"
          >
            ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </Button>
          <Button 
            onClick={handleSignUp} 
            variant="outline"
            loading={loading}
            className="w-full"
          >
            ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

## èªè¨¼ãƒã‚§ãƒƒã‚¯

### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰
```typescript
// app/(auth)/dashboard/page.tsx
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  return (
    <div>
      <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p>ã“ã‚“ã«ã¡ã¯ã€{user.email}ã•ã‚“</p>
    </div>
  );
}
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰
```typescript
// hooks/useAuth.ts
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import type { User } from "@supabase/supabase-js";

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const supabase = createClient();

  useEffect(() => {
    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      setUser(user);
      setLoading(false);
    };

    getUser();

    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (event, session) => {
        setUser(session?.user || null);
        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, [supabase.auth]);

  return { user, loading };
}
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

1. **ç’°å¢ƒå¤‰æ•°ç®¡ç†**: `.env.local`ã§ç®¡ç†ã€Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
2. **RLSãƒãƒªã‚·ãƒ¼**: å¿…ãšè¨­å®šã—ã€é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†
3. **å…¥åŠ›æ¤œè¨¼**: Zodã‚¹ã‚­ãƒ¼ãƒã§å¿…ãšãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
4. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§è‡ªå‹•æ›´æ–°
5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ­ã‚°è¨˜éŒ²

## èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š

### åˆå›ãƒªãƒªãƒ¼ã‚¹æ¨å¥¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆå³é¸4ã¤ï¼‰

#### ğŸ¯ **å¿…é ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰**

1. **Google** 
   - **ç†ç”±**: æœ€ã‚‚æ™®åŠã€ä¿¡é ¼æ€§ãŒé«˜ã„
   - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å±¤ï¼ˆç‰¹ã«ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
   - **ãƒ¡ãƒªãƒƒãƒˆ**: Gmailã€Googleãƒ•ã‚©ãƒˆé€£æºå¯èƒ½æ€§
   - **è¨­å®šå„ªå…ˆåº¦**: ğŸ”´ æœ€é«˜
   - **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä½

2. **X (Twitter)**
   - **ç†ç”±**: æ’®å½±æ¥­ç•Œãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ç•Œéšˆã§ä¸»è¦SNS
   - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: ãƒ¢ãƒ‡ãƒ«ã€ã‚«ãƒ¡ãƒ©ãƒãƒ³ã€é‹å–¶è€…
   - **ãƒ¡ãƒªãƒƒãƒˆ**: ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ»ä½œå“å…±æœ‰æ–‡åŒ–ã¨ã®è¦ªå’Œæ€§
   - **è¨­å®šå„ªå…ˆåº¦**: ğŸ”´ æœ€é«˜
   - **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä½

#### ğŸ¨ **æ¨å¥¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆå„ªå…ˆåº¦ï¼šä¸­ï¼‰**

3. **Discord**
   - **ç†ç”±**: ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§æ€¥é€Ÿã«æ™®åŠ
   - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: è‹¥å¹´å±¤ãƒ¢ãƒ‡ãƒ«ã€ã‚¢ãƒãƒãƒ¥ã‚¢ã‚«ãƒ¡ãƒ©ãƒãƒ³
   - **ãƒ¡ãƒªãƒƒãƒˆ**: ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ©Ÿèƒ½ã¨ã®é€£æºå¯èƒ½æ€§
   - **è¨­å®šå„ªå…ˆåº¦**: ğŸŸ¡ ä¸­
   - **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä½

4. **LINE**
   - **ç†ç”±**: æ—¥æœ¬å›½å†…ã§ã®åœ§å€’çš„æ™®åŠç‡ï¼ˆ90%ä»¥ä¸Šï¼‰
   - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: æ—¥æœ¬ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨èˆ¬
   - **ãƒ¡ãƒªãƒƒãƒˆ**: é€šçŸ¥ãƒ»é€£çµ¡æ‰‹æ®µã¨ã—ã¦ã‚‚æ´»ç”¨å¯èƒ½
   - **è¨­å®šå„ªå…ˆåº¦**: ğŸŸ¡ ä¸­
   - **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä¸­

#### âŒ **åˆå›ãƒªãƒªãƒ¼ã‚¹ã§ã¯è¦‹é€ã‚Š**
- **GitHub**: é–‹ç™ºè€…å‘ã‘ã™ãã‚‹ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã¨ä¸ä¸€è‡´
- **Facebook**: è‹¥å¹´å±¤é›¢ã‚Œã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æ‡¸å¿µ
- **Instagram**: Meta Business APIè¤‡é›‘ã€åˆå›ã«ã¯é‡ã„
- **Apple**: iOSé™å®šã€å®Ÿè£…ã‚³ã‚¹ãƒˆé«˜
- **Microsoft**: ä¼æ¥­å‘ã‘ã€å€‹äººã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã«ã¯ä¸é©

### å®Ÿè£…é †åº

```typescript
// 1. Googleï¼ˆæœ€å„ªå…ˆï¼‰
const handleGoogleSignIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  });
};

// 2. X (Twitter)ï¼ˆæœ€å„ªå…ˆï¼‰
const handleTwitterSignIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'twitter',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  });
};

// 3. Discordï¼ˆä¸­å„ªå…ˆï¼‰
const handleDiscordSignIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'discord',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  });
};

// 4. LINEï¼ˆä¸­å„ªå…ˆï¼‰
const handleLineSignIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'line',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  });
};
```

### è¨­å®šæ‰‹é †

1. **Supabase Dashboard**ã§å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æœ‰åŠ¹åŒ–
2. **OAuthè¨­å®š**ã§é©åˆ‡ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’è¨­å®š
3. **ç’°å¢ƒå¤‰æ•°**ã«å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’è¿½åŠ 
4. **ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒšãƒ¼ã‚¸**ã®å®Ÿè£…

### æˆ¦ç•¥çš„åˆ¤æ–­ç†ç”±

- **Google**: å¿…é ˆï¼ˆä¿¡é ¼æ€§ãƒ»æ™®åŠç‡ï¼‰
- **X**: å¿…é ˆï¼ˆæ¥­ç•Œè¦ªå’Œæ€§ãƒ»ä½œå“å…±æœ‰æ–‡åŒ–ï¼‰
- **Discord**: æ¨å¥¨ï¼ˆè‹¥å¹´å±¤ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼‰
- **LINE**: æ¨å¥¨ï¼ˆæ—¥æœ¬å¸‚å ´ç‰¹åŒ–ï¼‰

ã“ã®4ã¤ã§æ—¥æœ¬ã®æ’®å½±æ¥­ç•Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®95%ä»¥ä¸Šã‚’ã‚«ãƒãƒ¼å¯èƒ½ã€‚

## é‡è¦äº‹é …

- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¨­å®šã¯å¿…é ˆï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãŸã‚ï¼‰
- Server Componentã¨Client Componentã§ç•°ãªã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨
- èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã¯é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã¯`profiles`ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†
- **åˆå›ãƒªãƒªãƒ¼ã‚¹ã¯4ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«çµã‚Šã€æ®µéšçš„ã«æ‹¡å¼µ**
