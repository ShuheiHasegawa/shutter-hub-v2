name: ðŸš€ Deploy to Production

on:
  # main ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå€‹äººé–‹ç™ºæœ€é©åŒ–ï¼‰
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'next.config.ts'
      - 'tailwind.config.ts'
      - 'supabase/migrations/**'
      - '.github/workflows/deploy.yml'

  # æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_deploy:
        description: 'å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã‚‚å®Ÿè¡Œï¼‰'
        required: false
        default: false
        type: boolean

env:
  # Vercelè¨­å®š
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Node.jsè¨­å®š
  NODE_VERSION: '20'

jobs:
  # === ãƒ“ãƒ«ãƒ‰å‰ãƒã‚§ãƒƒã‚¯ ===
  pre-deploy-check:
    name: ðŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      deploy_environment: ${{ steps.check.outputs.deploy_environment }}

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®æ¯”è¼ƒã®ãŸã‚

      - name: ðŸ” ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¤å®š
        id: check
        run: |
          echo "=== ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¤å®šé–‹å§‹ ==="

          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "deploy_environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
          if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
            echo "å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ©ã‚°ãŒæœ‰åŠ¹ã§ã™"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "deploy_environment=production" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã®ã‚¹ã‚­ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MESSAGE" | grep -q "\[skip deploy\]"; then
            echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« [skip deploy] ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "$CHANGED_FILES"

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ãªå¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$CHANGED_FILES" | grep -qE "(src/|public/|package.*\.json|next\.config\.ts|tailwind\.config\.ts|supabase/migrations/)"; then
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "deploy_environment=production" >> $GITHUB_OUTPUT
          else
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤ä¸è¦ãªå¤‰æ›´ã®ã¿ã§ã™"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===
  database-migration:
    name: ðŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.should_deploy == 'true'
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ðŸ—„ï¸ Supabase CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: npm install -g @supabase/supabase-js

      - name: ðŸ” ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯
        run: |
          echo "=== ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯ ==="

          # æ–°ã—ã„ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -d "supabase/migrations" ]; then
            MIGRATION_COUNT=$(ls -1 supabase/migrations/*.sql 2>/dev/null | wc -l)
            echo "ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $MIGRATION_COUNT"
            
            if [ $MIGRATION_COUNT -gt 0 ]; then
              echo "âœ… ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
              ls -la supabase/migrations/
            else
              echo "âš ï¸ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
          else
            echo "âš ï¸ supabase/migrations ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
        continue-on-error: true

      - name: ðŸš€ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆMCPä½¿ç”¨ï¼‰
        run: |
          echo "=== MCPçµŒç”±ã§ã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ ==="
          echo "âš ï¸ å®Ÿéš›ã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã¯æ‰‹å‹•ç¢ºèªå¾Œã«è¡Œã„ã¾ã™"
          echo "ðŸ“‹ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †:"
          echo "1. ãƒ­ãƒ¼ã‚«ãƒ«ã§MCPé€£æºã‚’ä½¿ç”¨ã—ã¦ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…å®¹ã‚’ç¢ºèª"
          echo "2. Supabase Dashboardã§ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ³ã‚’ç¢ºèª"
          echo "3. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"
        continue-on-error: true

  # === ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ ===
  deploy:
    name: ðŸš€ ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, database-migration]
    if: needs.pre-deploy-check.outputs.should_deploy == 'true'
    timeout-minutes: 15

    environment:
      name: ${{ needs.pre-deploy-check.outputs.deploy_environment }}
      url: ${{ steps.deploy.outputs.deployment_url }}

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ðŸ”§ Vercel CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: npm install -g vercel@latest

      - name: ðŸ—ï¸ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: |
          echo "=== ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰é–‹å§‹ ==="
          npm run build
        env:
          # æœ¬ç•ªç’°å¢ƒå¤‰æ•°
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}

          # ãƒ“ãƒ«ãƒ‰è¨­å®š
          NODE_ENV: production
          SKIP_ENV_VALIDATION: true

      - name: ðŸš€ Vercel ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy
        run: |
          echo "=== Vercel ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ ==="

          # ç’°å¢ƒåˆ¤å®š
          if [ "${{ needs.pre-deploy-check.outputs.deploy_environment }}" = "production" ]; then
            VERCEL_ENV="--prod"
            echo "ðŸŽ¯ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"
          else
            VERCEL_ENV=""
            echo "ðŸ”§ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"
          fi

          # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
          DEPLOYMENT_URL=$(vercel deploy \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --confirm \
            $VERCEL_ENV \
            --force)

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $DEPLOYMENT_URL"
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

          # ã‚µãƒžãƒªãƒ¼ã«è¿½åŠ 
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- **ç’°å¢ƒ**: ${{ needs.pre-deploy-check.outputs.deploy_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [$DEPLOYMENT_URL]($DEPLOYMENT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚³ãƒŸãƒƒãƒˆ**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # === ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ===
  post-deploy-check:
    name: ðŸ¥ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, deploy]
    if: needs.pre-deploy-check.outputs.should_deploy == 'true'
    timeout-minutes: 10

    steps:
      - name: ðŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "=== ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ==="

          DEPLOYMENT_URL="${{ needs.deploy.outputs.deployment_url }}"

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

          echo "ðŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¯¾è±¡: $DEPLOYMENT_URL"

          # åŸºæœ¬æŽ¥ç¶šãƒã‚§ãƒƒã‚¯
          echo "ðŸ“¡ åŸºæœ¬æŽ¥ç¶šãƒã‚§ãƒƒã‚¯..."
          for i in {1..10}; do
            if curl -f -s "$DEPLOYMENT_URL" > /dev/null; then
              echo "âœ… åŸºæœ¬æŽ¥ç¶š: æˆåŠŸ"
              break
            fi
            echo "â³ å¾…æ©Ÿä¸­... ($i/10)"
            sleep 3
          done

          # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
          echo "ðŸ”Œ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯..."
          if curl -f -s "$DEPLOYMENT_URL/api/health" > /dev/null 2>&1; then
            echo "âœ… API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: åˆ©ç”¨å¯èƒ½"
          else
            echo "âš ï¸ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ç¢ºèªã§ãã¾ã›ã‚“ï¼ˆæ­£å¸¸ãªå ´åˆã‚‚ã‚ã‚Šã¾ã™ï¼‰"
          fi

          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ï¼‰
          echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯..."
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$DEPLOYMENT_URL" || echo "æ¸¬å®šå¤±æ•—")
          echo "ðŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${RESPONSE_TIME}ç§’"

          # çµæžœã‚µãƒžãƒªãƒ¼
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [$DEPLOYMENT_URL]($DEPLOYMENT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸºæœ¬æŽ¥ç¶š**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: ${RESPONSE_TIME}ç§’" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒã‚§ãƒƒã‚¯æ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  # === å®Œäº†é€šçŸ¥ ===
  notify:
    name: ðŸ“¢ å®Œäº†é€šçŸ¥
    runs-on: ubuntu-latest
    if: always() && needs.pre-deploy-check.outputs.should_deploy == 'true'
    needs: [pre-deploy-check, database-migration, deploy, post-deploy-check]
    timeout-minutes: 5

    steps:
      - name: ðŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœé€šçŸ¥
        run: |
          echo "## ðŸŽ¯ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å„æ®µéšŽã®çµæžœ
          echo "### ðŸ“‹ å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.database-migration.result }}" = "success" ]; then
            echo "âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: è­¦å‘Šã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.post-deploy-check.result }}" = "success" ]; then
            echo "âœ… **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

          # å€‹äººé–‹ç™ºæœ€é©åŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ å€‹äººé–‹ç™ºæœ€é©åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- è­¦å‘ŠãŒã‚ã£ã¦ã‚‚é–‹ç™ºã‚’å¦¨ã’ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "- é‡è¦ãªå•é¡Œã®ã¿å³åº§ã«å¯¾å¿œãŒå¿…è¦ã§ã™" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã‚‚æ‰‹å‹•ã§ä¿®æ­£ãƒ»å†å®Ÿè¡Œå¯èƒ½ã§ã™" >> $GITHUB_STEP_SUMMARY
