name: ðŸ”§ E2E Tests & Quality Assurance

on:
  # main ãƒ–ãƒ©ãƒ³ãƒã¸ã® push æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼ˆå€‹äººé–‹ç™ºæœ€é©åŒ–ï¼‰
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'supabase/**'
      - 'package*.json'
      - 'playwright.config.ts'
      - '.github/workflows/**'

  # æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - enhanced-escrow-payment
          - instant-photo-request
          - booking-systems
      browser:
        description: 'ãƒ–ãƒ©ã‚¦ã‚¶é¸æŠž'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: false
        type: boolean

env:
  # Node.jsè¨­å®š
  NODE_VERSION: '20'

  # ãƒ†ã‚¹ãƒˆè¨­å®š
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/ms-playwright

  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  NEXT_PUBLIC_APP_URL: http://localhost:8888
  PORT: 8888

jobs:
  # === é™çš„è§£æžãƒ»åž‹ãƒã‚§ãƒƒã‚¯ ===
  static-analysis:
    name: ðŸ” é™çš„è§£æžãƒ»åž‹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ðŸ” ESLint ãƒã‚§ãƒƒã‚¯
        run: npm run lint
        continue-on-error: true # å€‹äººé–‹ç™ºã§ã¯è­¦å‘Šã®ã¿

      - name: ðŸŽ¯ TypeScript åž‹ãƒã‚§ãƒƒã‚¯
        run: npx tsc --noEmit
        continue-on-error: true # å€‹äººé–‹ç™ºã§ã¯è­¦å‘Šã®ã¿

      - name: ðŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

  # === E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ===
  e2e-tests:
    name: ðŸŽ­ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: static-analysis
    continue-on-error: true # å€‹äººé–‹ç™ºã§ã¯å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¶™ç¶š

    strategy:
      fail-fast: false # è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆæ™‚ã€1ã¤å¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶™ç¶š
      matrix:
        browser:
          - ${{ (github.event.inputs.browser == 'all' && 'chromium') || github.event.inputs.browser || 'chromium' }}
          - ${{ (github.event.inputs.browser == 'all' && 'firefox') || '' }}
          - ${{ (github.event.inputs.browser == 'all' && 'webkit') || '' }}
        exclude:
          - browser: ''

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ðŸŽ­ Playwright ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ—„ï¸ Playwright ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ matrix.browser }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            playwright-${{ matrix.browser }}-

      - name: ðŸ—ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: ðŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
        run: npm start &
        env:
          # æœ¬ç•ªç”¨ç’°å¢ƒå¤‰æ•°ï¼ˆSecretsä½¿ç”¨ï¼‰
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}

          # ãƒ†ã‚¹ãƒˆç”¨è¨­å®š
          NODE_ENV: test
          SKIP_ENV_VALIDATION: true

      - name: â³ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¾…æ©Ÿ
        run: |
          echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¾…æ©Ÿä¸­..."
          for i in {1..30}; do
            if curl -f http://localhost:8888 > /dev/null 2>&1; then
              echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å®Œäº†"
              break
            fi
            echo "å¾…æ©Ÿä¸­... ($i/30)"
            sleep 2
          done

      - name: ðŸŽ­ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          # ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆé¸æŠž
          if [ "${{ github.event.inputs.test_suite }}" = "all" ] || [ -z "${{ github.event.inputs.test_suite }}" ]; then
            TEST_FILES="tests/e2e/*.spec.ts"
          else
            TEST_FILES="tests/e2e/${{ github.event.inputs.test_suite }}.spec.ts"
          fi

          # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š
          if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
            DEBUG_FLAGS="--headed --debug"
          else
            DEBUG_FLAGS=""
          fi

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          MCP_ENABLED=true \
          TEST_OAUTH_MOCK_ENABLED=true \
          npx playwright test $TEST_FILES \
            --project=${{ matrix.browser }} \
            --reporter=html,json,junit \
            $DEBUG_FLAGS
        env:
          # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°
          PLAYWRIGHT_BASE_URL: http://localhost:8888
          TEST_OAUTH_MOCK_ENABLED: true
          TEST_OAUTH_PROVIDER: google
          MCP_ENABLED: true
          MCP_AUTO_CLEANUP: true

          # Stripe ãƒ†ã‚¹ãƒˆç’°å¢ƒ
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}

          # Supabase ãƒ†ã‚¹ãƒˆç’°å¢ƒ
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

          # ãƒ‡ãƒãƒƒã‚°è¨­å®š
          NEXT_PUBLIC_ENABLE_DEBUG_LOGGING: true
          NEXT_PUBLIC_LOG_LEVEL: 3
          PLAYWRIGHT_RETRIES: 2
          PLAYWRIGHT_TIMEOUT: 45000
        continue-on-error: true # å€‹äººé–‹ç™ºã§ã¯å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š

      - name: ðŸ“Š ãƒ†ã‚¹ãƒˆçµæžœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: ðŸ“‹ ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼
        if: always()
        run: |
          echo "## ðŸŽ­ E2Eãƒ†ã‚¹ãƒˆçµæžœ (${{ matrix.browser }})" >> $GITHUB_STEP_SUMMARY

          if [ -f "test-results/results.json" ]; then
            # JSONçµæžœãƒ‘ãƒ¼ã‚¹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            TOTAL=$(jq '.stats.expected + .stats.unexpected + .stats.skipped' test-results/results.json 2>/dev/null || echo "ä¸æ˜Ž")
            PASSED=$(jq '.stats.expected' test-results/results.json 2>/dev/null || echo "ä¸æ˜Ž")
            FAILED=$(jq '.stats.unexpected' test-results/results.json 2>/dev/null || echo "ä¸æ˜Ž")
            SKIPPED=$(jq '.stats.skipped' test-results/results.json 2>/dev/null || echo "ä¸æ˜Ž")
            
            echo "- ðŸŽ¯ ç·ãƒ†ã‚¹ãƒˆæ•°: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æˆåŠŸ: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ å¤±æ•—: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: $SKIPPED" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED" != "0" ] && [ "$FAILED" != "ä¸æ˜Ž" ]; then
              echo "- âš ï¸ **ãƒ†ã‚¹ãƒˆå¤±æ•—ãŒã‚ã‚Šã¾ã™ãŒã€å€‹äººé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç¶™ç¶šã—ã¾ã™**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âš ï¸ ãƒ†ã‚¹ãƒˆçµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯ Artifacts ã® \`playwright-report-${{ matrix.browser }}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY

  # === çµæžœé›†ç´„ãƒ»é€šçŸ¥ ===
  summary:
    name: ðŸ“Š çµæžœé›†ç´„ãƒ»é€šçŸ¥
    runs-on: ubuntu-latest
    if: always()
    needs: [static-analysis, e2e-tests]
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµæžœã‚µãƒžãƒªãƒ¼
        run: |
          echo "## ðŸŽ¯ ShutterHub v2 å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # é™çš„è§£æžçµæžœ
          if [ "${{ needs.static-analysis.result }}" = "success" ]; then
            echo "âœ… **é™çš„è§£æž**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **é™çš„è§£æž**: è­¦å‘Šã‚ã‚Šï¼ˆå€‹äººé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç¶™ç¶šï¼‰" >> $GITHUB_STEP_SUMMARY
          fi

          # E2Eãƒ†ã‚¹ãƒˆçµæžœ
          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "âœ… **E2Eãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.e2e-tests.result }}" = "failure" ]; then
            echo "âš ï¸ **E2Eãƒ†ã‚¹ãƒˆ**: å¤±æ•—ã‚ã‚Šï¼ˆå€‹äººé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç¶™ç¶šï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **E2Eãƒ†ã‚¹ãƒˆ**: ã‚¹ã‚­ãƒƒãƒ—ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ å€‹äººé–‹ç™ºæœ€é©åŒ–è¨­å®š" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ **ãƒ—ãƒƒã‚·ãƒ¥ãƒ–ãƒ­ãƒƒã‚¯ãªã—**: å¤±æ•—æ™‚ã‚‚ \`main\` ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¯ç¶™ç¶š" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ**: ãƒ†ã‚¹ãƒˆçµæžœã¯ Artifacts ã¨ã—ã¦ä¿å­˜" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **é«˜é€Ÿãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: é‡è¦ãªå•é¡Œã®ã¿è­¦å‘Šè¡¨ç¤º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "- è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯ã€æ™‚é–“ãŒã‚ã‚‹æ™‚ã«ç¢ºèªãƒ»ä¿®æ­£" >> $GITHUB_STEP_SUMMARY
          echo "- ç·Šæ€¥æ€§ã®é«˜ã„å•é¡Œã¯å³åº§ã«å¯¾å¿œ" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ†ã‚¹ãƒˆå¤±æ•—ã¯é–‹ç™ºã®å¦¨ã’ã«ãªã‚‰ãªã„ã‚ˆã†ç¶™ç¶š" >> $GITHUB_STEP_SUMMARY

          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±è¡¨ç¤º
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ã‚³ãƒŸãƒƒãƒˆæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚³ãƒŸãƒƒã‚¿ãƒ¼**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # === ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ ===
  security-scan:
    name: ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    if: github.event_name == 'push' # pushæ™‚ã®ã¿å®Ÿè¡Œ
    timeout-minutes: 10
    continue-on-error: true # å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š

    steps:
      - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ðŸ”’ npm audit ãƒã‚§ãƒƒã‚¯
        run: |
          echo "## ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ" >> $GITHUB_STEP_SUMMARY

          # npm auditå®Ÿè¡Œ
          if npm audit --audit-level=high; then
            echo "âœ… **é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§**: ãªã—" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§**: æ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆè¦ç¢ºèªï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            npm audit --audit-level=high >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
